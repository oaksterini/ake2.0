<!doctype html>
<html lang="sv">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Projektvisare</title>
  <style>
    body { margin:0; font-family: sans-serif; display:flex; height:100vh; }
    #sidebar { width: 280px; background:#fafafa; border-right:1px solid #ddd; overflow:auto; padding:10px; }
    #viewer { flex:1; padding:10px; overflow:auto; white-space:pre-wrap; font-family:monospace; font-size:14px; }
    ul { list-style:none; margin:0; padding-left:16px; }
    li { cursor:pointer; margin:2px 0; }
    li.folder::before { content:"▸ "; }
    li.folder.open::before { content:"▾ "; }
    li.file { color:#0366d6; }
    li.file:hover { text-decoration:underline; }
    .path { font-size:12px; color:#666; margin-bottom:6px; }
  </style>
</head>
<body>
  <div id="sidebar">
    <h3>Projektfiler</h3>
    <ul id="tree"></ul>
  </div>
  <div id="viewer">
    <div class="path">Välj en fil till vänster</div>
  </div>

  <script>
    const OWNER = location.hostname.split('.')[0];
    const REPO = location.pathname.split('/')[1] || '';
    const BRANCH = 'main';
    const TOKEN = '';

    function apiFetch(url) {
      const headers = { 'Accept': 'application/vnd.github.v3+json' };
      if (TOKEN) headers['Authorization'] = 'token ' + TOKEN;
      return fetch(url,{headers}).then(r=>{ if(!r.ok) throw new Error(r.status); return r.json(); });
    }

    async function getTree(){
      const url=`https://api.github.com/repos/${OWNER}/${REPO}/git/trees/${BRANCH}?recursive=1`;
      const data=await apiFetch(url);
      return data.tree;
    }

    function buildTree(tree){
      const root={children:{}};
      tree.forEach(item=>{
        const parts=item.path.split('/');
        let node=root;
        parts.forEach((p,i)=>{
          if(!node.children[p]) node.children[p]={children:{}, type:(i===parts.length-1?item.type:'dir'), path:parts.slice(0,i+1).join('/')};
          node=node.children[p];
        });
      });
      return root;
    }

    function renderNode(node, parentEl){
      Object.keys(node.children).sort().forEach(name=>{
        const child=node.children[name];
        const li=document.createElement('li');
        li.textContent=name;
        if(child.type==='dir'){
          li.classList.add('folder');
          const ul=document.createElement('ul');
          ul.style.display='none';
          li.appendChild(ul);
          li.onclick=(e)=>{
            e.stopPropagation();
            const open=li.classList.toggle('open');
            ul.style.display=open?'block':'none';
            if(open && !ul.hasChildNodes()) renderNode(child,ul);
          };
        } else {
          li.classList.add('file');
          li.onclick=async(e)=>{
            e.stopPropagation();
            const rawUrl=`https://raw.githubusercontent.com/${OWNER}/${REPO}/${BRANCH}/${child.path}`;
            const r=await fetch(rawUrl);
            const text=await r.text();
            document.getElementById('viewer').innerHTML=`<div class=\"path\">${child.path} (<a href=\"${rawUrl}\" target=\"_blank\">raw</a>)</div><pre>${text.replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c]))}</pre>`;
          };
        }
        parentEl.appendChild(li);
      });
    }

    (async()=>{
      try{
        const tree=await getTree();
        const root=buildTree(tree);
        renderNode(root,document.getElementById('tree'));
      }catch(err){
        document.getElementById('viewer').textContent='Fel: '+err.message;
      }
    })();
  </script>
</body>
</html>
